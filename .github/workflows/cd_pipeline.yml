name: Continuous deployment

on:
  workflow_run:
    workflows: ["Continuous integration"]
    branches: [main]
    types: 
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
          python-version: 3.9

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.GIT_ID }}
        aws-secret-access-key: ${{ secrets.GIT_SECRET }}
        aws-region: sa-east-1
    
    - name: ZIP build
      run:  zip -r ${{ github.run_id }}.zip example-mlops

    - name: Upload to S3
      run: aws s3 cp ${{ github.run_id }}.zip s3://las-mlops/pucminas//${{ github.run_id }}.zip

    - name: Update lambda function code
      run: aws lambda update-function-code --function-name example-mlops --s3-bucket las-mlops/pucminas --s3-key ${{ github.run_id }}.zip

    - name: Sleep for 5 seconds
      run: sleep 5s
      shell: bash

    - name: Release lambda function version
      run: aws lambda publish-version --function-name example-mlops --description ${{ github.run_id }}